# Лабораторная работа 4
## Вариант: Библиотека

* **Цель:** Реализовать пользовательские коллекции для управления библиотекой, индексацию книг и псевдослучайную симуляцию событий.
* **Библиотеки:** *random*, *dataclasses*, *typing*.
* **Допущения:**
  - ISBN генерируются псевдослучайно; при совпадении ищется новое значение.
  - Поиск по автору/жанру/году нечувствителен к регистру.
  - Переиндексация (`refresh_indexes`) пересобирает все индексы с нуля.
  - При попытке удалить или получить несуществующую книгу выбрасывается `KeyError`.
  - Срезы коллекции книг возвращают новую `BookCollection`.
* **Чему я научился:**
  - Создавать пользовательские коллекции на композиции и словарях.
  - Применять магические методы для предметной модели.
  - Строить простую псевдослучайную симуляцию с воспроизводимым seed.

### Алгоритм решения
1. Определены `Book` (базовый), `PrintedBook` и `DigitalBook` (расширяют поведение, например `__call__`, `__repr__`).
2. Списковая коллекция `BookCollection` хранит книги, поддерживает `__iter__`, `__len__`, `__getitem__` срезы, `__add__`, `add/remove`, случайный `pop`.
3. Словарная коллекция `IndexDict` индексирует книги по ISBN, автору и году; методы `add/remove` синхронизируют все индексы.
4. `Library` объединяет коллекцию книг и индексы, предоставляет поиск по автору/жанру/году и доступ по ISBN.
5. Функции событий (добавление, удаление, поиски, переиндексация, проверка отсутствующей книги) логируют действия в консоль.
6. `run_simulation(steps, seed)` создаёт `random.Random(seed)`, на каждом шаге выбирает одно случайное событие из набора и исполняет его.

## Интересные тест-кейсы
- Повторное добавление книги с тем же ISBN предотвращается при генерации.
- Срезы коллекции (`collection[:3]`) возвращают новую коллекцию и сохраняют тип.
- Удаление книги синхронно обновляет индексы.
- Поиск по автору/жанру нечувствителен к регистру.
- Обработка отсутствующей книги через `KeyError` в событии `missing_lookup_event`.

## Инструкция к использованию

### Установить окружение
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### Запустить
```bash
# демонстрация с фиксированным seed
python - <<'PY'
from src.library import run_simulation
run_simulation(steps=20, seed=1)
PY

# запуск из точки входа
python -m src.main
```

### Тесты
```bash
.venv/bin/pytest
.venv/bin/pytest --cov=src
```

### Структура
- `src/library.py` - модели книг, коллекции, индексы, симуляция и события.
- `src/main.py` - точка входа `main()`, запускает `run_simulation`.
- `tests/test_library.py` - pytest-кейсы на модели, коллекции, индексы, события и симуляцию.
- `requirements.txt` - зависимости для запуска и тестов.
